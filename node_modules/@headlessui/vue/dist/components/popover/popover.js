import{Fragment as Z,computed as I,defineComponent as G,h as x,inject as V,provide as _,ref as C,shallowRef as ie,watchEffect as U,onMounted as ee,onUnmounted as te}from"vue";import{match as B}from'../../utils/match.js';import{render as $,Features as N}from'../../utils/render.js';import{useId as L}from'../../hooks/use-id.js';import{Keys as R}from'../../keyboard.js';import{getFocusableElements as q,Focus as D,focusIn as M,isFocusableElement as se,FocusableMode as pe,FocusResult as z}from'../../utils/focus-management.js';import{dom as r}from'../../utils/dom.js';import{useOpenClosedProvider as fe,State as H,useOpenClosed as oe}from'../../internal/open-closed.js';import{useResolveButtonType as ve}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as ce}from'../../hooks/use-outside-click.js';import{getOwnerDocument as W}from'../../utils/owner.js';import{useEventListener as de}from'../../hooks/use-event-listener.js';import{Hidden as J,Features as Q}from'../../internal/hidden.js';import{useTabDirection as ne,Direction as T}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';import{useRootContainers as Pe}from'../../hooks/use-root-containers.js';import{useNestedPortals as me}from'../../components/portal/portal.js';var be=(p=>(p[p.Open=0]="Open",p[p.Closed=1]="Closed",p))(be||{});let re=Symbol("PopoverContext");function A(d){let S=V(re,null);if(S===null){let p=new Error(`<${d} /> is missing a parent <${ge.name} /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(p,A),p}return S}let le=Symbol("PopoverGroupContext");function ae(){return V(le,null)}let ue=Symbol("PopoverPanelContext");function Se(){return V(ue,null)}let ge=G({name:"Popover",props:{as:{type:[Object,String],default:"div"}},setup(d,{slots:S,attrs:p,expose:h}){var v;let t=C(null);h({el:t,$el:t});let e=C(1),c=C(null),P=C(null),F=C(null),f=C(null),g=I(()=>W(t)),m=I(()=>{var X,Y;if(!r(c)||!r(f))return!1;for(let k of document.querySelectorAll("body > *"))if(Number(k==null?void 0:k.contains(r(c)))^Number(k==null?void 0:k.contains(r(f))))return!0;let o=q(),l=o.indexOf(r(c)),b=(l+o.length-1)%o.length,E=(l+1)%o.length,K=o[b],j=o[E];return!((X=r(f))!=null&&X.contains(K))&&!((Y=r(f))!=null&&Y.contains(j))}),a={popoverState:e,buttonId:C(null),panelId:C(null),panel:f,button:c,isPortalled:m,beforePanelSentinel:P,afterPanelSentinel:F,togglePopover(){e.value=B(e.value,{[0]:1,[1]:0})},closePopover(){e.value!==1&&(e.value=1)},close(o){a.closePopover();let l=(()=>o?o instanceof HTMLElement?o:o.value instanceof HTMLElement?r(o):r(a.button):r(a.button))();l==null||l.focus()}};_(re,a),fe(I(()=>B(e.value,{[0]:H.Open,[1]:H.Closed})));let w={buttonId:a.buttonId,panelId:a.panelId,close(){a.closePopover()}},y=ae(),O=y==null?void 0:y.registerPopover,[u,i]=me(),s=Pe({portals:u,defaultContainers:[c,f]});function n(){var o,l,b,E;return(E=y==null?void 0:y.isFocusWithinPopoverGroup())!=null?E:((o=g.value)==null?void 0:o.activeElement)&&(((l=r(c))==null?void 0:l.contains(g.value.activeElement))||((b=r(f))==null?void 0:b.contains(g.value.activeElement)))}return U(()=>O==null?void 0:O(w)),de((v=g.value)==null?void 0:v.defaultView,"focus",o=>{var l,b;o.target!==window&&o.target instanceof HTMLElement&&e.value===0&&(n()||c&&f&&(s.contains(o.target)||(l=r(a.beforePanelSentinel))!=null&&l.contains(o.target)||(b=r(a.afterPanelSentinel))!=null&&b.contains(o.target)||a.closePopover()))},!0),ce(s.resolveContainers,(o,l)=>{var b;a.closePopover(),se(l,pe.Loose)||(o.preventDefault(),(b=r(c))==null||b.focus())},I(()=>e.value===0)),()=>{let o={open:e.value===0,close:a.close};return x(i,{},()=>$({theirProps:{...d,...p},ourProps:{ref:t},slot:o,slots:S,attrs:p,name:"Popover"}))}}}),je=G({name:"PopoverButton",props:{as:{type:[Object,String],default:"button"},disabled:{type:[Boolean],default:!1},id:{type:String,default:()=>`headlessui-popover-button-${L()}`}},inheritAttrs:!1,setup(d,{attrs:S,slots:p,expose:h}){let t=A("PopoverButton"),e=I(()=>W(t.button));h({el:t.button,$el:t.button}),ee(()=>{t.buttonId.value=d.id}),te(()=>{t.buttonId.value=null});let c=ae(),P=c==null?void 0:c.closeOthers,F=Se(),f=I(()=>F===null?!1:F.value===t.panelId.value),g=C(null),m=`headlessui-focus-sentinel-${L()}`;f.value||U(()=>{t.button.value=g.value});let a=ve(I(()=>({as:d.as,type:S.type})),g);function w(n){var v,o,l,b,E;if(f.value){if(t.popoverState.value===1)return;switch(n.key){case R.Space:case R.Enter:n.preventDefault(),(o=(v=n.target).click)==null||o.call(v),t.closePopover(),(l=r(t.button))==null||l.focus();break}}else switch(n.key){case R.Space:case R.Enter:n.preventDefault(),n.stopPropagation(),t.popoverState.value===1&&(P==null||P(t.buttonId.value)),t.togglePopover();break;case R.Escape:if(t.popoverState.value!==0)return P==null?void 0:P(t.buttonId.value);if(!r(t.button)||(b=e.value)!=null&&b.activeElement&&!((E=r(t.button))!=null&&E.contains(e.value.activeElement)))return;n.preventDefault(),n.stopPropagation(),t.closePopover();break}}function y(n){f.value||n.key===R.Space&&n.preventDefault()}function O(n){var v,o;d.disabled||(f.value?(t.closePopover(),(v=r(t.button))==null||v.focus()):(n.preventDefault(),n.stopPropagation(),t.popoverState.value===1&&(P==null||P(t.buttonId.value)),t.togglePopover(),(o=r(t.button))==null||o.focus()))}function u(n){n.preventDefault(),n.stopPropagation()}let i=ne();function s(){let n=r(t.panel);if(!n)return;function v(){B(i.value,{[T.Forwards]:()=>M(n,D.First),[T.Backwards]:()=>M(n,D.Last)})===z.Error&&M(q().filter(l=>l.dataset.headlessuiFocusGuard!=="true"),B(i.value,{[T.Forwards]:D.Next,[T.Backwards]:D.Previous}),{relativeTo:r(t.button)})}v()}return()=>{let n=t.popoverState.value===0,v={open:n},{id:o,...l}=d,b=f.value?{ref:g,type:a.value,onKeydown:w,onClick:O}:{ref:g,id:o,type:a.value,"aria-expanded":d.disabled?void 0:t.popoverState.value===0,"aria-controls":r(t.panel)?t.panelId.value:void 0,disabled:d.disabled?!0:void 0,onKeydown:w,onKeyup:y,onClick:O,onMousedown:u};return x(Z,[$({ourProps:b,theirProps:{...S,...l},slot:v,attrs:S,slots:p,name:"PopoverButton"}),n&&!f.value&&t.isPortalled.value&&x(J,{id:m,features:Q.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:s})])}}}),Ne=G({name:"PopoverOverlay",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(d,{attrs:S,slots:p}){let h=A("PopoverOverlay"),t=`headlessui-popover-overlay-${L()}`,e=oe(),c=I(()=>e!==null?(e.value&H.Open)===H.Open:h.popoverState.value===0);function P(){h.closePopover()}return()=>{let F={open:h.popoverState.value===0};return $({ourProps:{id:t,"aria-hidden":!0,onClick:P},theirProps:d,slot:F,attrs:S,slots:p,features:N.RenderStrategy|N.Static,visible:c.value,name:"PopoverOverlay"})}}}),We=G({name:"PopoverPanel",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},focus:{type:Boolean,default:!1},id:{type:String,default:()=>`headlessui-popover-panel-${L()}`}},inheritAttrs:!1,setup(d,{attrs:S,slots:p,expose:h}){let{focus:t}=d,e=A("PopoverPanel"),c=I(()=>W(e.panel)),P=`headlessui-focus-sentinel-before-${L()}`,F=`headlessui-focus-sentinel-after-${L()}`;h({el:e.panel,$el:e.panel}),ee(()=>{e.panelId.value=d.id}),te(()=>{e.panelId.value=null}),_(ue,e.panelId),U(()=>{var i,s;if(!t||e.popoverState.value!==0||!e.panel)return;let u=(i=c.value)==null?void 0:i.activeElement;(s=r(e.panel))!=null&&s.contains(u)||M(r(e.panel),D.First)});let f=oe(),g=I(()=>f!==null?(f.value&H.Open)===H.Open:e.popoverState.value===0);function m(u){var i,s;switch(u.key){case R.Escape:if(e.popoverState.value!==0||!r(e.panel)||c.value&&!((i=r(e.panel))!=null&&i.contains(c.value.activeElement)))return;u.preventDefault(),u.stopPropagation(),e.closePopover(),(s=r(e.button))==null||s.focus();break}}function a(u){var s,n,v,o,l;let i=u.relatedTarget;i&&r(e.panel)&&((s=r(e.panel))!=null&&s.contains(i)||(e.closePopover(),((v=(n=r(e.beforePanelSentinel))==null?void 0:n.contains)!=null&&v.call(n,i)||(l=(o=r(e.afterPanelSentinel))==null?void 0:o.contains)!=null&&l.call(o,i))&&i.focus({preventScroll:!0})))}let w=ne();function y(){let u=r(e.panel);if(!u)return;function i(){B(w.value,{[T.Forwards]:()=>{var n;M(u,D.First)===z.Error&&((n=r(e.afterPanelSentinel))==null||n.focus())},[T.Backwards]:()=>{var s;(s=r(e.button))==null||s.focus({preventScroll:!0})}})}i()}function O(){let u=r(e.panel);if(!u)return;function i(){B(w.value,{[T.Forwards]:()=>{let s=r(e.button),n=r(e.panel);if(!s)return;let v=q(),o=v.indexOf(s),l=v.slice(0,o+1),E=[...v.slice(o+1),...l];for(let K of E.slice())if(K.dataset.headlessuiFocusGuard==="true"||n!=null&&n.contains(K)){let j=E.indexOf(K);j!==-1&&E.splice(j,1)}M(E,D.First,{sorted:!1})},[T.Backwards]:()=>{var n;M(u,D.Previous)===z.Error&&((n=r(e.button))==null||n.focus())}})}i()}return()=>{let u={open:e.popoverState.value===0,close:e.close},{id:i,focus:s,...n}=d,v={ref:e.panel,id:i,onKeydown:m,onFocusout:t&&e.popoverState.value===0?a:void 0,tabIndex:-1};return $({ourProps:v,theirProps:{...S,...n},attrs:S,slot:u,slots:{...p,default:(...o)=>{var l;return[x(Z,[g.value&&e.isPortalled.value&&x(J,{id:P,ref:e.beforePanelSentinel,features:Q.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:y}),(l=p.default)==null?void 0:l.call(p,...o),g.value&&e.isPortalled.value&&x(J,{id:F,ref:e.afterPanelSentinel,features:Q.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:O})])]}},features:N.RenderStrategy|N.Static,visible:g.value,name:"PopoverPanel"})}}}),Ae=G({name:"PopoverGroup",props:{as:{type:[Object,String],default:"div"}},setup(d,{attrs:S,slots:p,expose:h}){let t=C(null),e=ie([]),c=I(()=>W(t));h({el:t,$el:t});function P(m){let a=e.value.indexOf(m);a!==-1&&e.value.splice(a,1)}function F(m){return e.value.push(m),()=>{P(m)}}function f(){var w;let m=c.value;if(!m)return!1;let a=m.activeElement;return(w=r(t))!=null&&w.contains(a)?!0:e.value.some(y=>{var O,u;return((O=m.getElementById(y.buttonId.value))==null?void 0:O.contains(a))||((u=m.getElementById(y.panelId.value))==null?void 0:u.contains(a))})}function g(m){for(let a of e.value)a.buttonId.value!==m&&a.close()}return _(le,{registerPopover:F,unregisterPopover:P,isFocusWithinPopoverGroup:f,closeOthers:g}),()=>$({ourProps:{ref:t},theirProps:d,slot:{},attrs:S,slots:p,name:"PopoverGroup"})}});export{ge as Popover,je as PopoverButton,Ae as PopoverGroup,Ne as PopoverOverlay,We as PopoverPanel};
