import{Fragment as Q,computed as O,defineComponent as j,h as J,inject as X,nextTick as L,onMounted as U,onUnmounted as Y,provide as Z,ref as M,toRaw as m,watch as _,watchEffect as q}from"vue";import{Features as K,render as B,omit as W,compact as z}from'../../utils/render.js';import{useId as N}from'../../hooks/use-id.js';import{Keys as V}from'../../keyboard.js';import{calculateActiveIndex as ee,Focus as I}from'../../utils/calculate-active-index.js';import{dom as R}from'../../utils/dom.js';import{useOpenClosed as te,State as $,useOpenClosedProvider as oe}from'../../internal/open-closed.js';import{match as A}from'../../utils/match.js';import{useResolveButtonType as le}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ae}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ne}from'../../utils/focus-management.js';import{useOutsideClick as ie}from'../../hooks/use-outside-click.js';import{Hidden as ue,Features as re}from'../../internal/hidden.js';import{objectToFormEntries as se}from'../../utils/form.js';import{useControllable as de}from'../../hooks/use-controllable.js';import{useTrackedPointer as pe}from'../../hooks/use-tracked-pointer.js';import{isMobile as fe}from'../../utils/platform.js';import{disposables as be}from'../../utils/disposables.js';function ve(l,g){return l===g}var ce=(s=>(s[s.Open=0]="Open",s[s.Closed=1]="Closed",s))(ce||{}),me=(s=>(s[s.Single=0]="Single",s[s.Multi=1]="Multi",s))(me||{}),xe=(s=>(s[s.Pointer=0]="Pointer",s[s.Other=1]="Other",s))(xe||{});let G=Symbol("ComboboxContext");function H(l){let g=X(G,null);if(g===null){let s=new Error(`<${l} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,H),s}return g}let Ke=j({name:"Combobox",emits:{"update:modelValue":l=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>ve},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},form:{type:String,optional:!0},name:{type:String,optional:!0},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(l,{slots:g,attrs:s,emit:P}){let e=M(1),t=M(null),p=M(null),T=M(null),r=M(null),b=M({static:!1,hold:!1}),x=M([]),C=M(null),y=M(1),h=M(!1);function k(a=i=>i){let i=C.value!==null?x.value[C.value]:null,d=ne(a(x.value.slice()),f=>R(f.dataRef.domRef)),n=i?d.indexOf(i):null;return n===-1&&(n=null),{options:d,activeOptionIndex:n}}let w=O(()=>l.multiple?1:0),o=O(()=>l.nullable),[v,c]=de(O(()=>l.modelValue===void 0?A(w.value,{[1]:[],[0]:void 0}):l.modelValue),a=>P("update:modelValue",a),O(()=>l.defaultValue)),u={comboboxState:e,value:v,mode:w,compare(a,i){if(typeof l.by=="string"){let d=l.by;return(a==null?void 0:a[d])===(i==null?void 0:i[d])}return l.by(a,i)},defaultValue:O(()=>l.defaultValue),nullable:o,inputRef:p,labelRef:t,buttonRef:T,optionsRef:r,disabled:O(()=>l.disabled),options:x,change(a){c(a)},activeOptionIndex:O(()=>{if(h.value&&C.value===null&&x.value.length>0){let a=x.value.findIndex(i=>!i.dataRef.disabled);a!==-1&&(C.value=a)}return C.value}),activationTrigger:y,optionsPropsRef:b,closeCombobox(){h.value=!1,!l.disabled&&e.value!==1&&(e.value=1,C.value=null)},openCombobox(){if(h.value=!0,l.disabled||e.value===0)return;let a=x.value.findIndex(i=>{let d=m(i.dataRef.value);return A(w.value,{[0]:()=>u.compare(m(u.value.value),m(d)),[1]:()=>m(u.value.value).some(f=>u.compare(m(f),m(d)))})});a!==-1&&(C.value=a),e.value=0},goToOption(a,i,d){if(h.value=!1,l.disabled||r.value&&!b.value.static&&e.value===1)return;let n=k();if(n.activeOptionIndex===null){let S=n.options.findIndex(F=>!F.dataRef.disabled);S!==-1&&(n.activeOptionIndex=S)}let f=ee(a===I.Specific?{focus:I.Specific,id:i}:{focus:a},{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:S=>S.id,resolveDisabled:S=>S.dataRef.disabled});C.value=f,y.value=d!=null?d:1,x.value=n.options},selectOption(a){let i=x.value.find(n=>n.id===a);if(!i)return;let{dataRef:d}=i;c(A(w.value,{[0]:()=>d.value,[1]:()=>{let n=m(u.value.value).slice(),f=m(d.value),S=n.findIndex(F=>u.compare(f,m(F)));return S===-1?n.push(f):n.splice(S,1),n}}))},selectActiveOption(){if(u.activeOptionIndex.value===null)return;let{dataRef:a,id:i}=x.value[u.activeOptionIndex.value];c(A(w.value,{[0]:()=>a.value,[1]:()=>{let d=m(u.value.value).slice(),n=m(a.value),f=d.findIndex(S=>u.compare(n,m(S)));return f===-1?d.push(n):d.splice(f,1),d}})),u.goToOption(I.Specific,i)},registerOption(a,i){let d={id:a,dataRef:i},n=k(f=>[...f,d]);if(C.value===null){let f=i.value.value;A(w.value,{[0]:()=>u.compare(m(u.value.value),m(f)),[1]:()=>m(u.value.value).some(F=>u.compare(m(F),m(f)))})&&(n.activeOptionIndex=n.options.indexOf(d))}x.value=n.options,C.value=n.activeOptionIndex,y.value=1,n.options.some(f=>!R(f.dataRef.domRef))&&requestAnimationFrame(()=>{let f=k();x.value=f.options,C.value=f.activeOptionIndex})},unregisterOption(a){var d;u.activeOptionIndex.value!==null&&((d=u.options.value[u.activeOptionIndex.value])==null?void 0:d.id)===a&&(h.value=!0);let i=k(n=>{let f=n.findIndex(S=>S.id===a);return f!==-1&&n.splice(f,1),n});x.value=i.options,C.value=i.activeOptionIndex,y.value=1}};ie([p,T,r],()=>u.closeCombobox(),O(()=>e.value===0)),Z(G,u),oe(O(()=>A(e.value,{[0]:$.Open,[1]:$.Closed})));let D=O(()=>u.activeOptionIndex.value===null?null:x.value[u.activeOptionIndex.value].dataRef.value),E=O(()=>{var a;return(a=R(p))==null?void 0:a.closest("form")});return U(()=>{_([E],()=>{if(!E.value||l.defaultValue===void 0)return;function a(){u.change(l.defaultValue)}return E.value.addEventListener("reset",a),()=>{var i;(i=E.value)==null||i.removeEventListener("reset",a)}},{immediate:!0})}),()=>{let{name:a,disabled:i,form:d,...n}=l,f={open:e.value===0,disabled:i,activeIndex:u.activeOptionIndex.value,activeOption:D.value,value:v.value};return J(Q,[...a!=null&&v.value!=null?se({[a]:v.value}).map(([S,F])=>J(ue,z({features:re.Hidden,key:S,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:d,name:S,value:F}))):[],B({theirProps:{...s,...W(n,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:f,slots:g,attrs:s,name:"Combobox"})])}}}),$e=j({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${N()}`}},setup(l,{attrs:g,slots:s}){let P=H("ComboboxLabel");function e(){var t;(t=R(P.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:P.comboboxState.value===0,disabled:P.disabled.value},{id:p,...T}=l,r={id:p,ref:P.labelRef,onClick:e};return B({ourProps:r,theirProps:T,slot:t,attrs:g,slots:s,name:"ComboboxLabel"})}}}),Ue=j({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${N()}`}},setup(l,{attrs:g,slots:s,expose:P}){let e=H("ComboboxButton");P({el:e.buttonRef,$el:e.buttonRef});function t(r){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(r.preventDefault(),e.openCombobox()),L(()=>{var b;return(b=R(e.inputRef))==null?void 0:b.focus({preventScroll:!0})}))}function p(r){switch(r.key){case V.ArrowDown:r.preventDefault(),r.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.ArrowUp:r.preventDefault(),r.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),L(()=>{e.value.value||e.goToOption(I.Last)})),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.Escape:if(e.comboboxState.value!==0)return;r.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&r.stopPropagation(),e.closeCombobox(),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return}}let T=le(O(()=>({as:l.as,type:g.type})),e.buttonRef);return()=>{var y,h;let r={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:b,...x}=l,C={ref:e.buttonRef,id:b,type:T.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(y=R(e.optionsRef))==null?void 0:y.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(h=R(e.labelRef))==null?void 0:h.id,b].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:p,onClick:t};return B({ourProps:C,theirProps:x,slot:r,attrs:g,slots:s,name:"ComboboxButton"})}}}),_e=j({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${N()}`}},emits:{change:l=>!0},setup(l,{emit:g,attrs:s,slots:P,expose:e}){let t=H("ComboboxInput"),p={value:!1};e({el:t.inputRef,$el:t.inputRef});let T=O(()=>{var v;let o=t.value.value;return R(t.inputRef)?typeof l.displayValue!="undefined"&&o!==void 0?(v=l.displayValue(o))!=null?v:"":typeof o=="string"?o:"":""});U(()=>{_([T,t.comboboxState],([o,v],[c,u])=>{if(p.value)return;let D=R(t.inputRef);D&&(u===0&&v===1||o!==c)&&(D.value=o)},{immediate:!0}),_([t.comboboxState],([o],[v])=>{if(o===0&&v===1){let c=R(t.inputRef);if(!c)return;let u=c.value,{selectionStart:D,selectionEnd:E,selectionDirection:a}=c;c.value="",c.value=u,a!==null?c.setSelectionRange(D,E,a):c.setSelectionRange(D,E)}})});let r=M(!1),b=M(null);function x(){r.value=!0}function C(){be().nextFrame(()=>{r.value=!1,b.value&&(t.openCombobox(),g("change",b.value),b.value=null)})}function y(o){switch(p.value=!0,o.key){case V.Backspace:case V.Delete:if(t.mode.value!==0||!t.nullable.value)return;let v=o.currentTarget;requestAnimationFrame(()=>{if(v.value===""){t.change(null);let c=R(t.optionsRef);c&&(c.scrollTop=0),t.goToOption(I.Nothing)}});break;case V.Enter:if(p.value=!1,t.comboboxState.value!==0||r.value)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case V.ArrowDown:return p.value=!1,o.preventDefault(),o.stopPropagation(),A(t.comboboxState.value,{[0]:()=>t.goToOption(I.Next),[1]:()=>t.openCombobox()});case V.ArrowUp:return p.value=!1,o.preventDefault(),o.stopPropagation(),A(t.comboboxState.value,{[0]:()=>t.goToOption(I.Previous),[1]:()=>{t.openCombobox(),L(()=>{t.value.value||t.goToOption(I.Last)})}});case V.Home:if(o.shiftKey)break;return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(I.First);case V.PageUp:return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(I.First);case V.End:if(o.shiftKey)break;return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(I.Last);case V.PageDown:return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(I.Last);case V.Escape:if(p.value=!1,t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case V.Tab:if(p.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function h(o){if(r.value){b.value=o;return}t.openCombobox(),g("change",o)}function k(){p.value=!1}let w=O(()=>{var o,v,c,u;return(u=(c=(v=l.defaultValue)!=null?v:t.defaultValue.value!==void 0?(o=l.displayValue)==null?void 0:o.call(l,t.defaultValue.value):null)!=null?c:t.defaultValue.value)!=null?u:""});return()=>{var a,i,d,n,f,S;let o={open:t.comboboxState.value===0},{id:v,displayValue:c,onChange:u,...D}=l,E={"aria-controls":(a=t.optionsRef.value)==null?void 0:a.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(i=t.options.value[t.activeOptionIndex.value])==null?void 0:i.id,"aria-labelledby":(f=(d=R(t.labelRef))==null?void 0:d.id)!=null?f:(n=R(t.buttonRef))==null?void 0:n.id,"aria-autocomplete":"list",id:v,onCompositionstart:x,onCompositionend:C,onKeydown:y,onInput:h,onBlur:k,role:"combobox",type:(S=s.type)!=null?S:"text",tabIndex:0,ref:t.inputRef,defaultValue:w.value,disabled:t.disabled.value===!0?!0:void 0};return B({ourProps:E,theirProps:D,slot:o,attrs:s,slots:P,features:K.RenderStrategy|K.Static,name:"ComboboxInput"})}}}),qe=j({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(l,{attrs:g,slots:s,expose:P}){let e=H("ComboboxOptions"),t=`headlessui-combobox-options-${N()}`;P({el:e.optionsRef,$el:e.optionsRef}),q(()=>{e.optionsPropsRef.value.static=l.static}),q(()=>{e.optionsPropsRef.value.hold=l.hold});let p=te(),T=O(()=>p!==null?(p.value&$.Open)===$.Open:e.comboboxState.value===0);return ae({container:O(()=>R(e.optionsRef)),enabled:O(()=>e.comboboxState.value===0),accept(r){return r.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:r.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(r){r.setAttribute("role","none")}}),()=>{var C,y,h;let r={open:e.comboboxState.value===0},b={"aria-labelledby":(h=(C=R(e.labelRef))==null?void 0:C.id)!=null?h:(y=R(e.buttonRef))==null?void 0:y.id,id:t,ref:e.optionsRef,role:"listbox","aria-multiselectable":e.mode.value===1?!0:void 0},x=W(l,["hold"]);return B({ourProps:b,theirProps:x,slot:r,attrs:g,slots:s,features:K.RenderStrategy|K.Static,visible:T.value,name:"ComboboxOptions"})}}}),Je=j({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(l,{slots:g,attrs:s,expose:P}){let e=H("ComboboxOption"),t=`headlessui-combobox-option-${N()}`,p=M(null);P({el:p,$el:p});let T=O(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),r=O(()=>A(e.mode.value,{[0]:()=>e.compare(m(e.value.value),m(l.value)),[1]:()=>m(e.value.value).some(o=>e.compare(m(o),m(l.value)))})),b=O(()=>({disabled:l.disabled,value:l.value,domRef:p}));U(()=>e.registerOption(t,b)),Y(()=>e.unregisterOption(t)),q(()=>{e.comboboxState.value===0&&T.value&&e.activationTrigger.value!==0&&L(()=>{var o,v;return(v=(o=R(p))==null?void 0:o.scrollIntoView)==null?void 0:v.call(o,{block:"nearest"})})});function x(o){if(l.disabled)return o.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox(),fe()||requestAnimationFrame(()=>{var v;return(v=R(e.inputRef))==null?void 0:v.focus()})}function C(){if(l.disabled)return e.goToOption(I.Nothing);e.goToOption(I.Specific,t)}let y=pe();function h(o){y.update(o)}function k(o){y.wasMoved(o)&&(l.disabled||T.value||e.goToOption(I.Specific,t,0))}function w(o){y.wasMoved(o)&&(l.disabled||T.value&&(e.optionsPropsRef.value.hold||e.goToOption(I.Nothing)))}return()=>{let{disabled:o}=l,v={active:T.value,selected:r.value,disabled:o},c={id:t,ref:p,role:"option",tabIndex:o===!0?void 0:-1,"aria-disabled":o===!0?!0:void 0,"aria-selected":r.value,disabled:void 0,onClick:x,onFocus:C,onPointerenter:h,onMouseenter:h,onPointermove:k,onMousemove:k,onPointerleave:w,onMouseleave:w};return B({ourProps:c,theirProps:l,slot:v,attrs:s,slots:g,name:"ComboboxOption"})}}});export{Ke as Combobox,Ue as ComboboxButton,_e as ComboboxInput,$e as ComboboxLabel,Je as ComboboxOption,qe as ComboboxOptions};
