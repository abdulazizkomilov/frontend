import{Fragment as Q,computed as S,defineComponent as I,h as K,inject as z,nextTick as C,onMounted as B,onUnmounted as _,provide as q,ref as D,toRaw as T,watch as N,watchEffect as W}from"vue";import{Features as H,render as E,omit as G,compact as J}from'../../utils/render.js';import{useId as A}from'../../hooks/use-id.js';import{Keys as p}from'../../keyboard.js';import{calculateActiveIndex as X,Focus as O}from'../../utils/calculate-active-index.js';import{dom as c}from'../../utils/dom.js';import{useOpenClosed as Y,State as F,useOpenClosedProvider as Z}from'../../internal/open-closed.js';import{match as P}from'../../utils/match.js';import{useResolveButtonType as ee}from'../../hooks/use-resolve-button-type.js';import{FocusableMode as te,isFocusableElement as oe,sortByDomNode as ie}from'../../utils/focus-management.js';import{useOutsideClick as ae}from'../../hooks/use-outside-click.js';import{Hidden as ne,Features as le}from'../../internal/hidden.js';import{objectToFormEntries as ue}from'../../utils/form.js';import{useControllable as re}from'../../hooks/use-controllable.js';import{useTrackedPointer as se}from'../../hooks/use-tracked-pointer.js';import{useTextValue as de}from'../../hooks/use-text-value.js';function fe(t,v){return t===v}var pe=(u=>(u[u.Open=0]="Open",u[u.Closed=1]="Closed",u))(pe||{}),ce=(u=>(u[u.Single=0]="Single",u[u.Multi=1]="Multi",u))(ce||{}),ve=(u=>(u[u.Pointer=0]="Pointer",u[u.Other=1]="Other",u))(ve||{});function be(t){requestAnimationFrame(()=>requestAnimationFrame(t))}let U=Symbol("ListboxContext");function j(t){let v=z(U,null);if(v===null){let u=new Error(`<${t} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,j),u}return v}let Fe=I({name:"Listbox",emits:{"update:modelValue":t=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>fe},horizontal:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},form:{type:String,optional:!0},name:{type:String,optional:!0},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(t,{slots:v,attrs:u,emit:L}){let e=D(1),s=D(null),b=D(null),m=D(null),f=D([]),o=D(""),a=D(null),w=D(1);function k(i=n=>n){let n=a.value!==null?f.value[a.value]:null,l=ie(i(f.value.slice()),x=>c(x.dataRef.domRef)),d=n?l.indexOf(n):null;return d===-1&&(d=null),{options:l,activeOptionIndex:d}}let g=S(()=>t.multiple?1:0),[y,M]=re(S(()=>t.modelValue===void 0?P(g.value,{[1]:[],[0]:void 0}):t.modelValue),i=>L("update:modelValue",i),S(()=>t.defaultValue)),h={listboxState:e,value:y,mode:g,compare(i,n){if(typeof t.by=="string"){let l=t.by;return(i==null?void 0:i[l])===(n==null?void 0:n[l])}return t.by(i,n)},orientation:S(()=>t.horizontal?"horizontal":"vertical"),labelRef:s,buttonRef:b,optionsRef:m,disabled:S(()=>t.disabled),options:f,searchQuery:o,activeOptionIndex:a,activationTrigger:w,closeListbox(){t.disabled||e.value!==1&&(e.value=1,a.value=null)},openListbox(){t.disabled||e.value!==0&&(e.value=0)},goToOption(i,n,l){if(t.disabled||e.value===1)return;let d=k(),x=X(i===O.Specific?{focus:O.Specific,id:n}:{focus:i},{resolveItems:()=>d.options,resolveActiveIndex:()=>d.activeOptionIndex,resolveId:R=>R.id,resolveDisabled:R=>R.dataRef.disabled});o.value="",a.value=x,w.value=l!=null?l:1,f.value=d.options},search(i){if(t.disabled||e.value===1)return;let l=o.value!==""?0:1;o.value+=i.toLowerCase();let x=(a.value!==null?f.value.slice(a.value+l).concat(f.value.slice(0,a.value+l)):f.value).find(V=>V.dataRef.textValue.startsWith(o.value)&&!V.dataRef.disabled),R=x?f.value.indexOf(x):-1;R===-1||R===a.value||(a.value=R,w.value=1)},clearSearch(){t.disabled||e.value!==1&&o.value!==""&&(o.value="")},registerOption(i,n){let l=k(d=>[...d,{id:i,dataRef:n}]);f.value=l.options,a.value=l.activeOptionIndex},unregisterOption(i){let n=k(l=>{let d=l.findIndex(x=>x.id===i);return d!==-1&&l.splice(d,1),l});f.value=n.options,a.value=n.activeOptionIndex,w.value=1},select(i){t.disabled||M(P(g.value,{[0]:()=>i,[1]:()=>{let n=T(h.value.value).slice(),l=T(i),d=n.findIndex(x=>h.compare(l,T(x)));return d===-1?n.push(l):n.splice(d,1),n}}))}};ae([b,m],(i,n)=>{var l;h.closeListbox(),oe(n,te.Loose)||(i.preventDefault(),(l=c(b))==null||l.focus())},S(()=>e.value===0)),q(U,h),Z(S(()=>P(e.value,{[0]:F.Open,[1]:F.Closed})));let r=S(()=>{var i;return(i=c(b))==null?void 0:i.closest("form")});return B(()=>{N([r],()=>{if(!r.value||t.defaultValue===void 0)return;function i(){h.select(t.defaultValue)}return r.value.addEventListener("reset",i),()=>{var n;(n=r.value)==null||n.removeEventListener("reset",i)}},{immediate:!0})}),()=>{let{name:i,modelValue:n,disabled:l,form:d,...x}=t,R={open:e.value===0,disabled:l,value:y.value};return K(Q,[...i!=null&&y.value!=null?ue({[i]:y.value}).map(([V,$])=>K(ne,J({features:le.Hidden,key:V,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:d,name:V,value:$}))):[],E({ourProps:{},theirProps:{...u,...G(x,["defaultValue","onUpdate:modelValue","horizontal","multiple","by"])},slot:R,slots:v,attrs:u,name:"Listbox"})])}}}),Be=I({name:"ListboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-listbox-label-${A()}`}},setup(t,{attrs:v,slots:u}){let L=j("ListboxLabel");function e(){var s;(s=c(L.buttonRef))==null||s.focus({preventScroll:!0})}return()=>{let s={open:L.listboxState.value===0,disabled:L.disabled.value},{id:b,...m}=t,f={id:b,ref:L.labelRef,onClick:e};return E({ourProps:f,theirProps:m,slot:s,attrs:v,slots:u,name:"ListboxLabel"})}}}),Ke=I({name:"ListboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-listbox-button-${A()}`}},setup(t,{attrs:v,slots:u,expose:L}){let e=j("ListboxButton");L({el:e.buttonRef,$el:e.buttonRef});function s(o){switch(o.key){case p.Space:case p.Enter:case p.ArrowDown:o.preventDefault(),e.openListbox(),C(()=>{var a;(a=c(e.optionsRef))==null||a.focus({preventScroll:!0}),e.value.value||e.goToOption(O.First)});break;case p.ArrowUp:o.preventDefault(),e.openListbox(),C(()=>{var a;(a=c(e.optionsRef))==null||a.focus({preventScroll:!0}),e.value.value||e.goToOption(O.Last)});break}}function b(o){switch(o.key){case p.Space:o.preventDefault();break}}function m(o){e.disabled.value||(e.listboxState.value===0?(e.closeListbox(),C(()=>{var a;return(a=c(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})})):(o.preventDefault(),e.openListbox(),be(()=>{var a;return(a=c(e.optionsRef))==null?void 0:a.focus({preventScroll:!0})})))}let f=ee(S(()=>({as:t.as,type:v.type})),e.buttonRef);return()=>{var g,y;let o={open:e.listboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:a,...w}=t,k={ref:e.buttonRef,id:a,type:f.value,"aria-haspopup":"listbox","aria-controls":(g=c(e.optionsRef))==null?void 0:g.id,"aria-expanded":e.disabled.value?void 0:e.listboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=c(e.labelRef))==null?void 0:y.id,a].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:s,onKeyup:b,onClick:m};return E({ourProps:k,theirProps:w,slot:o,attrs:v,slots:u,name:"ListboxButton"})}}}),Ne=I({name:"ListboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},id:{type:String,default:()=>`headlessui-listbox-options-${A()}`}},setup(t,{attrs:v,slots:u,expose:L}){let e=j("ListboxOptions"),s=D(null);L({el:e.optionsRef,$el:e.optionsRef});function b(o){switch(s.value&&clearTimeout(s.value),o.key){case p.Space:if(e.searchQuery.value!=="")return o.preventDefault(),o.stopPropagation(),e.search(o.key);case p.Enter:if(o.preventDefault(),o.stopPropagation(),e.activeOptionIndex.value!==null){let a=e.options.value[e.activeOptionIndex.value];e.select(a.dataRef.value)}e.mode.value===0&&(e.closeListbox(),C(()=>{var a;return(a=c(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})}));break;case P(e.orientation.value,{vertical:p.ArrowDown,horizontal:p.ArrowRight}):return o.preventDefault(),o.stopPropagation(),e.goToOption(O.Next);case P(e.orientation.value,{vertical:p.ArrowUp,horizontal:p.ArrowLeft}):return o.preventDefault(),o.stopPropagation(),e.goToOption(O.Previous);case p.Home:case p.PageUp:return o.preventDefault(),o.stopPropagation(),e.goToOption(O.First);case p.End:case p.PageDown:return o.preventDefault(),o.stopPropagation(),e.goToOption(O.Last);case p.Escape:o.preventDefault(),o.stopPropagation(),e.closeListbox(),C(()=>{var a;return(a=c(e.buttonRef))==null?void 0:a.focus({preventScroll:!0})});break;case p.Tab:o.preventDefault(),o.stopPropagation();break;default:o.key.length===1&&(e.search(o.key),s.value=setTimeout(()=>e.clearSearch(),350));break}}let m=Y(),f=S(()=>m!==null?(m.value&F.Open)===F.Open:e.listboxState.value===0);return()=>{var g,y,M,h;let o={open:e.listboxState.value===0},{id:a,...w}=t,k={"aria-activedescendant":e.activeOptionIndex.value===null||(g=e.options.value[e.activeOptionIndex.value])==null?void 0:g.id,"aria-multiselectable":e.mode.value===1?!0:void 0,"aria-labelledby":(h=(y=c(e.labelRef))==null?void 0:y.id)!=null?h:(M=c(e.buttonRef))==null?void 0:M.id,"aria-orientation":e.orientation.value,id:a,onKeydown:b,role:"listbox",tabIndex:0,ref:e.optionsRef};return E({ourProps:k,theirProps:w,slot:o,attrs:v,slots:u,features:H.RenderStrategy|H.Static,visible:f.value,name:"ListboxOptions"})}}}),He=I({name:"ListboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1},id:{type:String,default:()=>`headlessui-listbox.option-${A()}`}},setup(t,{slots:v,attrs:u,expose:L}){let e=j("ListboxOption"),s=D(null);L({el:s,$el:s});let b=S(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t.id:!1),m=S(()=>P(e.mode.value,{[0]:()=>e.compare(T(e.value.value),T(t.value)),[1]:()=>T(e.value.value).some(r=>e.compare(T(r),T(t.value)))})),f=S(()=>P(e.mode.value,{[1]:()=>{var i;let r=T(e.value.value);return((i=e.options.value.find(n=>r.some(l=>e.compare(T(l),T(n.dataRef.value)))))==null?void 0:i.id)===t.id},[0]:()=>m.value})),o=de(s),a=S(()=>({disabled:t.disabled,value:t.value,get textValue(){return o()},domRef:s}));B(()=>e.registerOption(t.id,a)),_(()=>e.unregisterOption(t.id)),B(()=>{N([e.listboxState,m],()=>{e.listboxState.value===0&&m.value&&P(e.mode.value,{[1]:()=>{f.value&&e.goToOption(O.Specific,t.id)},[0]:()=>{e.goToOption(O.Specific,t.id)}})},{immediate:!0})}),W(()=>{e.listboxState.value===0&&b.value&&e.activationTrigger.value!==0&&C(()=>{var r,i;return(i=(r=c(s))==null?void 0:r.scrollIntoView)==null?void 0:i.call(r,{block:"nearest"})})});function w(r){if(t.disabled)return r.preventDefault();e.select(t.value),e.mode.value===0&&(e.closeListbox(),C(()=>{var i;return(i=c(e.buttonRef))==null?void 0:i.focus({preventScroll:!0})}))}function k(){if(t.disabled)return e.goToOption(O.Nothing);e.goToOption(O.Specific,t.id)}let g=se();function y(r){g.update(r)}function M(r){g.wasMoved(r)&&(t.disabled||b.value||e.goToOption(O.Specific,t.id,0))}function h(r){g.wasMoved(r)&&(t.disabled||b.value&&e.goToOption(O.Nothing))}return()=>{let{disabled:r}=t,i={active:b.value,selected:m.value,disabled:r},{id:n,value:l,disabled:d,...x}=t,R={id:n,ref:s,role:"option",tabIndex:r===!0?void 0:-1,"aria-disabled":r===!0?!0:void 0,"aria-selected":m.value,disabled:void 0,onClick:w,onFocus:k,onPointerenter:y,onMouseenter:y,onPointermove:M,onMousemove:M,onPointerleave:h,onMouseleave:h};return E({ourProps:R,theirProps:x,slot:i,attrs:u,slots:v,name:"ListboxOption"})}}});export{Fe as Listbox,Ke as ListboxButton,Be as ListboxLabel,He as ListboxOption,Ne as ListboxOptions};
